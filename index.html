<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <title>NYC Crime Project</title>
</head>

<body>
    <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
        <a class="navbar-brand" href="#">NYC Crime Project</a>
        <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Dropdown button
                </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" href="#">Action</a>
                <a class="dropdown-item" href="#">Another action</a>
                <a class="dropdown-item" href="#">Something else here</a>
            </div>
        </div>
    </nav>

    <p class="lead">This visualization shows the precinct level rates for Stop-Question-Frisk data through the years 2003-2016</p>

    <div class="form-group">
        <label for="sel1">Select year:</label>
        <select class="form-control" id="year">
              <option>2003</option>
              <option selected="true">2004</option>
              <option>2005</option>
              <option>2006</option>
              <option>2007</option>
              <option>2008</option>
              <option>2009</option>
              <option>2010</option>
              <option>2011</option>
              <option>2012</option>
              <option>2013</option>
              <option>2014</option>
              <option>2015</option>
              <option>2016</option>
            </select>
    </div>

    <div class="container">
        <div class="col">
            <svg height=540 width=540></svg>
        </div>
        <div class="col-sm">
            <table class="table hidden">
                <thead>
                    <tr>
                        <th scope="col">Year</th>
                        <th scope="col">Number of Stops</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!-- <script src="https://d3js.org/topojson.v1.min.js"></script> -->


    <script>
        let width = 540
        let height = 540
        let svg = d3.select("svg").attr("height", height).attr("width", width)
        let map = svg.append("g")

        var selectedYear = 2004
        var selectedPrecinct = undefined


        d3.json("Police Precincts.geojson", function(error, geoData) {
            if (error) throw error
            d3.csv("precinct_sqf.csv", function(error, countData) {
                if (error) throw error

                let countsByPrecinct = d3.nest()
                    .key(d => d.pct.trim())
                    .sortKeys(d3.ascending)
                    .rollup(d => d)
                    .object(countData)
                console.log(countsByPrecinct)

                console.log(geoData)
                    // add to geoData
                geoData.features.forEach(d => d.properties.counts = countsByPrecinct[d.properties.precinct])

                let max = d3.max(countData, d => d.count)
                let min = d3.min(countData, d => d.count)

                // TODO: use something other than viridis
                let colorScale = d3.scaleSequential(d3.interpolateViridis).domain([max, min]).clamp(true)

                let path = d3.geoPath()
                    .projection(d3.geoConicConformal()
                        .parallels([33, 45])
                        .rotate([90, -30])
                        .fitSize([width, height], geoData));

                // HELPER FUNCTIONS
                function pickData(d) {
                    let count = d.properties.counts.find(c => c.year === String(selectedYear))
                    return count && count.count ? Number(count.count) : NaN
                }

                function updateMap() {
                    map.selectAll("path")
                        .attr("fill", d => colorScale(pickData(d)))
                        .attr("stroke", "white")
                        .attr("stroke-width", null)
                        .on("click", function(d) {
                            updateMap()
                            d3.select(this).attr("stroke-width", "2px").attr("stroke", "lightgrey")

                            console.log(d.properties.counts)
                            let table = d3.select("tbody").selectAll("tr").remove().data(d.properties.counts)
                            let rows = table.enter().append("tr").merge(table)
                            rows.append("th").text(d => d.year)
                            rows.append("td").text(d => d.count)

                            table.exit().remove()
                        })
                }

                map.selectAll("path")
                    .data(geoData.features)
                    .enter().append("path")
                    .attr("d", path)

                updateMap()

                d3.select("select").on("change", function() {
                    selectedYear = this.value
                    updateMap()
                })
            })
        })
    </script>
</body>

</html>